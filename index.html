<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Technician Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" media="print" onload="this.media='all'">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <div class="container">
            <h1>Data Technician Dashboard</h1>
            <div id="thai-date" class="thai-date"></div>
            <div class="dev-info">Dev.by Installation & Maintenance</div>
        </div>
    </header>
    
    <div class="container">
        <div id="error-message" class="error" style="display: none;"></div>
        
        <div id="loading" class="loading">
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <div style="border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
                <p id="loading-text" style="margin-top: 15px;">กำลังโหลดข้อมูล...</p>
                <p id="loading-status" style="margin-top: 10px; font-size: 0.9rem; color: #666;"></p>
            </div>
            <style>
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                
                /* Provider Cards Styles */
                .provider-card {
                    transition: transform 0.3s ease, box-shadow 0.3s ease;
                    cursor: default;
                }
                
                .provider-card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 8px 25px rgba(0,0,0,0.2) !important;
                }
                
                /* Responsive Design for Provider Cards */
                @media (max-width: 768px) {
                    #provider-cards-container > div {
                        flex-direction: column;
                    }
                    
                    .provider-card {
                        margin-bottom: 10px;
                    }
                }
            </style>
        </div>
        
        <!-- การ์ดสรุปจำนวน Provider เหนือกราฟ RSM -->
        <div id="provider-cards-container" style="display: none; margin: 20px 0; width: 100%;">
            <div style="display: flex; gap: 10px; justify-content: space-between;">
                <!-- การ์ดจำนวนรวมทั้งหมด -->
                <div class="provider-card" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                        <i class="fas fa-users" style="font-size: 30px; opacity: 0.7; margin-bottom: 8px;"></i>
                        <h4 style="margin: 0; font-size: 12px; opacity: 0.9;">กองงานทั้งหมด</h4>
                        <div id="total-all-providers" style="font-size: 20px; font-weight: bold; margin-top: 5px; white-space: nowrap;">0</div>
                    </div>
                </div>
                
                <!-- การ์ด WW-Provider -->
                <div class="provider-card" style="flex: 1; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                        <i class="fas fa-building" style="font-size: 30px; opacity: 0.7; margin-bottom: 8px;"></i>
                        <h4 style="margin: 0; font-size: 12px; opacity: 0.9;">WW-Provider</h4>
                        <div id="total-ww-provider" style="font-size: 20px; font-weight: bold; margin-top: 5px; white-space: nowrap;">0</div>
                    </div>
                </div>
                
                <!-- การ์ด True Tech -->
                <div class="provider-card" style="flex: 1; background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                        <i class="fas fa-tools" style="font-size: 30px; opacity: 0.7; margin-bottom: 8px;"></i>
                        <h4 style="margin: 0; font-size: 12px; opacity: 0.9;">True Tech</h4>
                        <div id="total-true-tech" style="font-size: 20px; font-weight: bold; margin-top: 5px; white-space: nowrap;">0</div>
                    </div>
                </div>
                
                <!-- การ์ด เถ้าแก่เทค -->
                <div class="provider-card" style="flex: 1; background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                        <i class="fas fa-wrench" style="font-size: 30px; opacity: 0.7; margin-bottom: 8px;"></i>
                        <h4 style="margin: 0; font-size: 12px; opacity: 0.9;">เถ้าแก่เทค</h4>
                        <div id="total-thaokae-tech" style="font-size: 20px; font-weight: bold; margin-top: 5px; white-space: nowrap;">0</div>
                    </div>
                </div>
                
                <!-- การ์ดจำนวน Depot ทั้งหมด -->
                <div class="provider-card" style="flex: 1; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                        <i class="fas fa-store" style="font-size: 30px; opacity: 0.7; margin-bottom: 8px;"></i>
                        <h4 style="margin: 0; font-size: 12px; opacity: 0.9;">Depot ทั้งหมด</h4>
                        <div id="total-all-depots" style="font-size: 28px; font-weight: bold; margin-top: 5px;">0</div>
                    </div>
                </div>
                
                <!-- การ์ด Depot WW-Provider -->
                <div class="provider-card" style="flex: 1; background: linear-gradient(135deg, #5dade2 0%, #2e86de 100%); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                        <i class="fas fa-warehouse" style="font-size: 30px; opacity: 0.7; margin-bottom: 8px;"></i>
                        <h4 style="margin: 0; font-size: 12px; opacity: 0.9;">Depot WW</h4>
                        <div id="depot-ww-provider" style="font-size: 28px; font-weight: bold; margin-top: 5px;">0</div>
                    </div>
                </div>
                
                <!-- การ์ด Depot True Tech -->
                <div class="provider-card" style="flex: 1; background: linear-gradient(135deg, #48c9b0 0%, #16a085 100%); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                        <i class="fas fa-industry" style="font-size: 30px; opacity: 0.7; margin-bottom: 8px;"></i>
                        <h4 style="margin: 0; font-size: 12px; opacity: 0.9;">Depot True</h4>
                        <div id="depot-true-tech" style="font-size: 28px; font-weight: bold; margin-top: 5px;">0</div>
                    </div>
                </div>
                
                <!-- การ์ด Depot เถ้าแก่เทค -->
                <div class="provider-card" style="flex: 1; background: linear-gradient(135deg, #bb8fce 0%, #7d3c98 100%); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="display: flex; flex-direction: column; align-items: center; text-align: center;">
                        <i class="fas fa-shop" style="font-size: 30px; opacity: 0.7; margin-bottom: 8px;"></i>
                        <h4 style="margin: 0; font-size: 12px; opacity: 0.9;">Depot เถ้าแก่</h4>
                        <div id="depot-thaokae-tech" style="font-size: 28px; font-weight: bold; margin-top: 5px;">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ปรับโครงสร้างใหม่: กราฟ 2 อันอยู่ในบรรทัดเดียวกัน -->
        <div id="dashboard-chart-container" style="display: flex; justify-content: space-between; margin-bottom: 20px; gap: 20px; flex-wrap: wrap;">
            <!-- กราฟ Provider Chart (ซ้าย) -->
            <div id="provider-chart-container" class="chart-container" style="display: none; margin: 0; width: 48%; height: 400px;">
                <canvas id="providerChart"></canvas>
            </div>
            
            <!-- กราฟ RSM Chart (ขวา) -->
            <div id="chart-container" class="chart-container" style="display: none; margin: 0; width: 48%; height: 400px;">
                <canvas id="rsmChart"></canvas>
            </div>
        </div>
        
        <!-- กราฟ CTM Chart ใหม่ -->
        <div id="ctm-chart-container" class="chart-container" style="display: none; margin: 20px 0; width: 100%; height: 500px;">
            <canvas id="ctmChart"></canvas>
        </div>
        
        <!-- ตาราง Pivot Table สรุปกองงานช่าง -->
        <div id="pivot-table-container" class="pivot-table-container" style="display: none; margin: 20px auto; max-width: 600px;">
            <h3 style="margin-bottom: 15px; color: var(--secondary-color); font-size: 1.2rem; text-align: center;">สรุปกองงานช่าง</h3>
            <table id="pivot-table" class="pivot-table" style="width: 100%;">
                <thead>
                    <tr>
                        <th>Provider</th>
                        <th>Install</th>
                        <th>Repair</th>
                        <th>รวม</th>
                    </tr>
                </thead>
                <tbody id="pivot-table-body">
                    <!-- ข้อมูลจะถูกเพิ่มที่นี่ด้วย JavaScript -->
                </tbody>
                <tfoot>
                    <tr id="pivot-total-row">
                        <th>รวม</th>
                        <th id="total-installation">0</th>
                        <th id="total-repair">0</th>
                        <th id="grand-total">0</th>
                    </tr>
                </tfoot>
            </table>
        </div>

        
        <div id="table-container" class="table-container" style="display: none;">
            <div class="table-controls">
                <div class="search-container">
                    <input type="text" id="search-input" class="search-input" placeholder="ค้นหาข้อมูล...">
                    <button id="search-button">ค้นหา</button>
                    <button id="refresh-button">รีเฟรช</button>
                </div>
                <div class="rows-per-page">
                    <label for="rows-select">แสดง:</label>
                    <select id="rows-select">
                        <option value="25" selected>25 แถว</option>
                        <option value="50">50 แถว</option>
                        <option value="100">100 แถว</option>
                        <option value="500">500 แถว</option>
                    </select>
                    <button id="download-excel">ดาวน์โหลด Excel</button>
                </div>
            </div>
            <table id="data-table">
                <!-- Table will be populated here -->
            </table>
            <div id="pagination" class="pagination">
                <!-- Pagination will be populated here -->
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>&copy; 2025 Data Technician Dashboard</p>
            <div id="visitor-counter" style="position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 15px; border-radius: 25px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000; font-size: 14px;">
                <i class="fas fa-users" style="margin-right: 8px;"></i>
                <span id="counter-number">0</span> ผู้เยี่ยมชม
            </div>
        </div>
    </footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // CSV URL - ใช้ URL เดียวที่ทำงานได้แน่นอน
        const csvUrl = "https://docs.google.com/spreadsheets/d/1phZPRcTJqNiwCGaDWGS-VxSsojiPrPzQPDcoIRHqgWw/export?format=csv&gid=813367910";
        
        // CORS Proxy URL ที่ทำงานได้ดี
        const corsProxyUrl = "https://corsproxy.io/?";
        
        // Elements
        const loadingElement = document.getElementById('loading');
        const loadingTextElement = document.getElementById('loading-text');
        const loadingStatusElement = document.getElementById('loading-status');
        const tableContainerElement = document.getElementById('table-container');
        const dataTableElement = document.getElementById('data-table');
        const errorMessageElement = document.getElementById('error-message');
        const thaiDateElement = document.getElementById('thai-date');
        const dashboardElement = document.getElementById('dashboard');
        const paginationElement = document.getElementById('pagination');
        const searchInputElement = document.getElementById('search-input');
        const searchButtonElement = document.getElementById('search-button');
        const rowsSelectElement = document.getElementById('rows-select');
        const downloadExcelElement = document.getElementById('download-excel');
        const pivotTableContainerElement = document.getElementById('pivot-table-container');
        const pivotTableBodyElement = document.getElementById('pivot-table-body');
        
        // Update loading status
        function updateLoadingStatus(message) {
            if (loadingStatusElement) {
                loadingStatusElement.textContent = message;
            }
            console.log('Loading status:', message);
        }
        
        // Data state
        let allData = []; // Original filtered data
        let displayData = []; // Data after search filter
        let currentPage = 1;
        let rowsPerPage = 25; // Default
        let searchTerm = '';
        let currentSortColumn = ''; // คอลัมน์ที่ใช้เรียงลำดับปัจจุบัน
        let currentSortDirection = 'asc'; // ทิศทางการเรียงลำดับปัจจุบัน (asc หรือ desc)
        let csvCache = null; // สำหรับเก็บข้อมูล CSV ในหน่วยความจำ
        let lastFetchTime = 0; // เวลาที่ดึงข้อมูลครั้งล่าสุด
        const CACHE_DURATION = 5 * 60 * 1000; // 5 นาที (เป็นมิลลิวินาที)
        let rsmChart = null; // สำหรับเก็บอ็อบเจ็กต์ Chart
        let providerChart = null; // สำหรับเก็บอ็อบเจ็กต์ Provider Chart
        let ctmChart = null; // สำหรับเก็บอ็อบเจ็กต์ CTM Chart
        
        // Thai date formatter
        function formatThaiDate() {
            const now = new Date();
            const thaiMonths = [
                'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
            ];
            const day = now.getDate();
            const month = thaiMonths[now.getMonth()];
            const year = now.getFullYear() + 543; // Convert to Buddhist Era
            
            // Add time
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            return `วันที่ ${day} ${month} พ.ศ. ${year} เวลา ${hours}:${minutes}:${seconds} น.`;
        }
        
        // Update Thai date
        function updateThaiDate() {
            thaiDateElement.textContent = formatThaiDate();
        }
        
        // Main function to fetch and process data
        async function fetchDataAndVisualize() {
            try {
                // Update Thai date
                updateThaiDate();
                
                // Start real-time clock update (ลดเป็น 5 วินาทีต่อครั้ง)
                setInterval(updateThaiDate, 5000);
                
                const now = Date.now();
                
                // ตรวจสอบแคช ถ้ามีและยังไม่หมดอายุให้ใช้แคช
                if (csvCache && (now - lastFetchTime < CACHE_DURATION)) {
                    console.log('Using cached data');
                    processData(csvCache);
                    return;
                }
                
                // Show loading message
                console.log('Fetching data from Google Sheets...');
                updateLoadingStatus('กำลังโหลดข้อมูลจาก Google Sheets...');
                
                // ใช้ CORS proxy เพื่อหลีกเลี่ยงปัญหา CORS
                const finalUrl = corsProxyUrl + encodeURIComponent(csvUrl);
                
                console.log('Fetching from:', finalUrl);
                
                // Fetch CSV data
                const response = await fetch(finalUrl);
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                
                // Check if csvText is not empty
                if (!csvText || csvText.length === 0) {
                    throw new Error('CSV data is empty');
                }
                
                console.log('CSV data fetched successfully, length:', csvText.length);
                        updateLoadingStatus('โหลดข้อมูลสำเร็จ กำลังประมวลผล...');
                
                // บันทึกลงแคช
                csvCache = csvText;
                lastFetchTime = now;
                
                // ประมวลผลข้อมูล
                processData(csvText);
            } catch (error) {
                console.error('Error details:', error);
                showError(`เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}`);
            }
        }
        
        // ฟังก์ชันโหลดข้อมูลตัวอย่าง
        function loadSampleData() {
            console.log('Loading sample data as fallback...');
            updateLoadingStatus('กำลังโหลดข้อมูลตัวอย่าง...');
            
            // สร้างข้อมูลตัวอย่าง
            const sampleData = [
                {
                    'Area': 'UPC',
                    'Provider': 'WW-Provider',
                    'CTM': 'สมุทรสงคราม',
                    'RSM': 'RSM7_UPC-CEW',
                    'Type of Provider Group': 'Install-Repair',
                    'Type of work': 'Repair',
                    'ประเภทการรับงาน': 'Multi Skill',
                    'Group': 'W&W',
                    'Province': 'สมุทรสงคราม',
                    'Depot_Name': 'บริษัท ทองเซลลูล่าร์ กรุ๊ป จำกัด',
                    'Depot_Code': '05-C750',
                    'O-Type': 'Repair',
                    'จำนวนกองงาน': '1',
                    'จำนวนช่าง': '1',
                    'Tech_Name': 'ชาตรี',
                    'Tech_Surename': 'ออกประทุม',
                    'Tech_ID': '333042',
                    'Register_Date': '02/27',
                    'Expire_Date': '28/02/27',
                    'บัตรหมดอายุ(วัน)': '531',
                    'Status': 'Active',
                    'สถานะกองงาน': 'หัวหน้า'
                }
            ];
            
            // ประมวลผลข้อมูลตัวอย่าง
            allData = sampleData;
            displayData = [...allData];
            
            setTimeout(() => {
                loadingElement.style.display = 'none';
            }, 500);
            
            document.getElementById('chart-container').style.display = 'block';
            document.getElementById('provider-cards-container').style.display = 'block';
            document.getElementById('provider-chart-container').style.display = 'block';
            document.getElementById('ctm-chart-container').style.display = 'block';
            pivotTableContainerElement.style.display = 'block';
            tableContainerElement.style.display = 'block';
            
            createRSMChart(sampleData);
            createProviderCards(sampleData);
            createProviderChart(sampleData);
            createCTMChart(sampleData);
            createPivotTable(sampleData);
            createFilterOptions();
            setupLazyLoading();
            setupChartClickHandler();
            
            // แสดงข้อความเตือน
            showError('ไม่สามารถโหลดข้อมูลจาก Google Sheets ได้ กำลังแสดงข้อมูลตัวอย่าง');
        }
        
        // เพิ่มการโหลดข้อมูลแบบ lazy loading
        function setupLazyLoading() {
            // ตรวจสอบว่าเบราว์เซอร์รองรับ Intersection Observer หรือไม่
            if ('IntersectionObserver' in window) {
                const tableContainer = document.getElementById('table-container');
                
                // สร้าง observer เพื่อดักจับเมื่อตารางปรากฏในหน้าจอ
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            // เมื่อตารางปรากฏในหน้าจอ ให้ทำการโหลดข้อมูล
                            renderTable();
                            // ยกเลิกการดักจับหลังจากโหลดเสร็จ
                            observer.unobserve(entry.target);
                        }
                    });
                }, {
                    rootMargin: '100px', // โหลดล่วงหน้าเมื่อใกล้จะเห็นตาราง 100px
                    threshold: 0.1 // โหลดเมื่อตารางปรากฏอย่างน้อย 10%
                });
                
                // เริ่มดักจับตาราง
                observer.observe(tableContainer);
            } else {
                // ถ้าเบราว์เซอร์ไม่รองรับ Intersection Observer ให้โหลดตารางตามปกติ
                renderTable();
            }
        }
        
        // ปรับปรุงฟังก์ชัน processData ให้ใช้ lazy loading
        function processData(csvText) {
            console.log('Processing CSV data, length:', csvText.length);
            console.log('First 500 characters:', csvText.substring(0, 500));
            
            Papa.parse(csvText, {
                header: true,
                complete: function(results) {
                    console.log('Papa Parse results:', results);
                    const data = results.data;
                    console.log('Raw data length:', data.length);
                    // ใช้ชุดคอลัมน์ให้ตรงกับที่ต้องการแสดง: ตัด I (index 8) ออก และเพิ่ม O (index 14)
                    // กรองข้อมูลเฉพาะ Provider ที่ต้องการและเลือกเฉพาะคอลัมน์ที่ต้องการ
                    // A=0, B=1, D=3, E=4, F=5, G=6, H=7, J=9, K=10, L=11, N=13, O=14, P=15, Q=16, R=17, S=18, T=19, W=22, Y=24, Z=25, AB=27 (ไม่รวม AF)
                    const columnsToKeep = ['Area', 'Provider', 'CTM', 'RSM', 'Type of Provider Group', 'Type of work', 
                                         'ประเภทการรับงาน', 'Province', 'Depot_Name', 'Depot_Code', 'Team_Name', 
                                         'Type', 'จำนวนกองงาน', 'จำนวนช่าง', 'สถานะกองงาน', 'Tech_Name', 
                                         'Tech_Surename', 'Tech_ID', 'Register_Date', 'Expire_Date', 'บัตรหมดอายุ(วัน)'];
                    
                    const filteredData = data.filter(row => {
                        // กรองเฉพาะ Provider ที่ต้องการ
                        const provider = row['Provider'] || '';
                        const validProviders = ['WW-Provider', 'เถ้าแก่เทค', 'True Tech'];
                        
                        // กรองเฉพาะ Type of work ที่ต้องการ (คอลัมน์ G)
                        const typeOfWork = row['Type of work'] || '';
                        const validWorkTypes = ['Installation', 'Repair'];
                        
                        // ต้องผ่านทั้ง Provider และ Type of work
                        return validProviders.includes(provider) && validWorkTypes.includes(typeOfWork);
                    }).map(row => {
                        // เลือกเฉพาะคอลัมน์ที่ต้องการ
                        const newRow = {};
                        for (const key in row) {
                            if (columnsToKeep.includes(key)) {
                                newRow[key] = row[key];
                            }
                        }
                        return newRow;
                    });
                    
                    console.log('Filtered by Provider and Type of work:', filteredData.length, 'rows from', data.length);
                    console.log('Filters applied: Provider (WW-Provider, เถ้าแก่เทค, True Tech) AND Type of work (Installation, Repair)');
                    console.log('Columns in filtered data:', Object.keys(filteredData[0] || {}));
                    console.log('Sample filtered row:', filteredData[0]);
                    
                    // ไม่กรองข้อมูลก่อน เพื่อให้แสดงข้อมูลทั้งหมด
                    // filteredData.forEach(row => {
                    //     if (row['Type of work'] === 'MPLS' || row['Type of work'] === 'Other' || row['Type of work'] === 'Audit(QC)' || row['Type of work'] === 'Solar') {
                    //         row['Type of work'] = '';
                    //     }
                    // });
                    
                    allData = filteredData;
                    displayData = [...allData];
                    
                    console.log('Final data ready:', allData.length, 'records');
                    updateLoadingStatus('เสร็จสิ้น!');
                    
                    setTimeout(() => {
                    loadingElement.style.display = 'none';
                    }, 500);
                    document.getElementById('chart-container').style.display = 'block';
                    document.getElementById('provider-cards-container').style.display = 'block';
                    document.getElementById('provider-chart-container').style.display = 'block';
                    document.getElementById('ctm-chart-container').style.display = 'block';
                    pivotTableContainerElement.style.display = 'block';
                    tableContainerElement.style.display = 'block';
                    
                    createRSMChart(filteredData);
                    createProviderCards(filteredData);
                    createProviderChart(filteredData);
                    createCTMChart(filteredData);
                    createPivotTable(filteredData);
                    createFilterOptions();
                    setupLazyLoading();
                    setupChartClickHandler();
                },
                error: function(error) {
                    showError("Error parsing CSV: " + error.message);
                }
            });
        }
        
        // Filter columns from data
        function filterColumns(data, columnsToKeep) {
            if (data.length === 0) return [];
            
            const allColumns = Object.keys(data[0]);
            
    // ใช้รายการ columnsToKeep ที่ส่งเข้ามา (คงโครงสร้างเดิม แต่อัปเดต index แล้ว)
    const selectedColumnIndices = columnsToKeep;
    const selectedColumns = selectedColumnIndices
        .map(i => (i < allColumns.length ? allColumns[i] : null))
        .filter(Boolean);

    const columnBName = allColumns[1];   // Provider
    const columnIName = allColumns[8];   // Group (ใช้กรอง TVG แต่ไม่แสดง)
    const columnOTypeName = allColumns[14]; // O-Type
    const columnTypeOfWork = allColumns[6];  // Type of work

    const allowedOType = new Set(['FTTB', 'FTTH', 'FTTH-MDU', 'REPAIR']);

            return data
                .filter(row => {
            // เงื่อนไขพื้นฐานเดิม
            const basicCondition =
                (row[columnBName] === 'WW-Provider' ||
                 row[columnBName] === 'เถ้าแก่เทค' ||
                 row[columnBName] === 'True Tech') &&
                row[columnIName] !== 'TVG';

            if (!basicCondition) return false;

            // อนุญาตเฉพาะ Type of work ที่ไม่ใช่ MPLS/Other/Audit(QC)/Solar
            const workVal = (row[columnTypeOfWork] || '').toString();
            if (['MPLS', 'Other', 'Audit(QC)', 'Solar'].some(x => workVal === x)) return false;

            // เงื่อนไข O-Type: ยอมรับ FTTB/FTTH/FTTH-MDU/REPAIR (ไม่ติดเคส ว่างมี space ได้)
            const oTypeRaw = (row[columnOTypeName] || '').toString().trim().toUpperCase();

            // ถ้าเป็นงาน Repair ให้ผ่าน แม้ O-Type ว่าง
            const isRepairWork = workVal.toLowerCase().includes('repair');

            // ผ่านหาก O-Type อยู่ใน allowed หรือเป็นงาน Repair
            if (!isRepairWork && !allowedOType.has(oTypeRaw)) return false;

            return true;
                })
                .map(row => {
                    const newRow = {};
                    selectedColumns.forEach(col => {
                // เก็บค่าเดิมทุกคอลัมน์ (ยกเว้นซ่อนค่า Work ที่ไม่ต้องการ ซึ่งกรองทิ้งไปแล้ว)
                            newRow[col] = row[col];
                    });
                    return newRow;
                });
        }
        
        // นับจำนวนหัวหน้าจากคอลัมน์สถานะกองงาน
        function countLeadersInData(data) {
            // ใช้คอลัมน์สถานะกองงาน
            const columnName = 'สถานะกองงาน';
            
            // นับจำนวนข้อมูลที่มีคำว่า "หัวหน้า"
            const leadersCount = data.filter(row => {
                const value = row[columnName];
                return value && value.toString().includes('หัวหน้า');
            }).length;
            
            // คืนค่าจำนวนที่นับได้
            return leadersCount;
        }
        
        // สร้างการ์ดสำหรับแสดงจำนวนหัวหน้า
        function createLeadersCardElement(data) {
            const leadersCount = countLeadersInData(data);
            
            // สร้างการ์ด
            const card = document.createElement('div');
            card.className = 'card';
            card.style.flex = '1';
            card.style.cursor = 'pointer';
            card.style.transition = 'all 0.3s ease';
            card.innerHTML = `
            <i class="fas fa-building card-icon"></i>
            <h3>จำนวนช่าง<br>(กองงาน)</h3>
            <div class="count-number">${leadersCount.toLocaleString()}</div>
            `;
            
            // เพิ่ม click event
            card.addEventListener('click', function() {
                // กรองข้อมูลเฉพาะหัวหน้า (กองงาน)
                const filteredData = data.filter(row => {
                    const statusValue = row['สถานะกองงาน'];
                    return statusValue && statusValue.toString().includes('หัวหน้า');
                });
                
                // อัปเดตการ์ดและตาราง
                createDashboardSummary(filteredData);
                createRSMChart(allData, filteredData);
                createProviderChart(allData, filteredData);
                createCTMChart(allData, filteredData);
                createPivotTable(filteredData);
                showFilterMessage('แสดงข้อมูลเฉพาะหัวหน้ากองงาน');
                
                // เพิ่ม visual feedback
                highlightActiveCard(card);
            });
            
            // เพิ่ม hover effect
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            });
            
            return card;
        }
        
        // นับจำนวนช่าง
        function countTechsInData(data) {
            // นับจำนวนข้อมูลทั้งหมด
            return data.length;
        }
        
        // สร้างการ์ดสำหรับแสดงจำนวนช่าง(คน)
        function createTechsCardElement(data) {
            const techsCount = countTechsInData(data);
            
            // สร้างการ์ด
            const card = document.createElement('div');
            card.className = 'card';
            card.style.flex = '1';
            card.style.cursor = 'pointer';
            card.style.transition = 'all 0.3s ease';
            card.innerHTML = `
            <i class="fas fa-users card-icon"></i>
            <h3>จำนวนช่าง<br>(คน)</h3>
            <div class="count-number">${techsCount.toLocaleString()}</div>
            `;
            
            // เพิ่ม click event
            card.addEventListener('click', function() {
                // แสดงข้อมูลทั้งหมด (ไม่กรอง)
                createRSMChart(allData);
                createProviderChart(allData);
                createCTMChart(allData);
                showFilterMessage('แสดงข้อมูลทั้งหมด');
                
                // เพิ่ม visual feedback
                highlightActiveCard(card);
            });
            
            // เพิ่ม hover effect
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            });
            
            return card;
        }
        
        // นับจำนวนช่างติดตั้ง
function countInstallTechsInData(data) {
    // นับจำนวนข้อมูลที่มีคำว่า "Installation" ในคอลัมน์ Type of work และมีคำว่า "หัวหน้า" หรือ "ลูกน้อง" ในคอลัมน์สถานะกองงาน
    const installCount = data.filter(row => {
        const workValue = row['Type of work'];
        const statusValue = row['สถานะกองงาน'];
        return workValue && 
               workValue.toString().includes('Installation') && 
               statusValue && 
               (statusValue.toString().includes('หัวหน้า') || statusValue.toString().includes('ลูกน้อง'));
    }).length;
    
    return installCount;
}
        
        // สร้างการ์ดสำหรับแสดงจำนวนช่างติดตั้ง
function createInstallTechsCardElement(data) {
    const installCount = countInstallTechsInData(data);
    
    // นับจำนวนกองงานช่างติดตั้ง (นับเฉพาะที่มีคำว่า "หัวหน้า" ในคอลัมน์ "สถานะกองงาน")
    const installGroupCount = data.filter(row => {
        const typeValue = row['Type of work'];
        const statusValue = row['สถานะกองงาน'];
        return typeValue && 
              typeValue.toString().includes('Installation') && 
              statusValue && 
              statusValue.toString().includes('หัวหน้า');
    }).length;
            
            // สร้างการ์ด
            const card = document.createElement('div');
            card.className = 'card';
            card.style.flex = '1';
            card.style.cursor = 'pointer';
            card.style.transition = 'all 0.3s ease';
            card.innerHTML = `
            <i class="fas fa-tools card-icon"></i>
            <h3>ช่างติดตั้ง</h3>
            <div class="card-detail-line">
                <span class="card-detail-value">${installGroupCount.toLocaleString()}</span>
                <span class="card-detail-label">กองงาน</span>
            </div>
            <div class="card-detail-line">
                <span class="card-detail-value">${installCount.toLocaleString()}</span>
                <span class="card-detail-label">คน</span>
            </div>
            `;
            
            // เพิ่ม click event
            card.addEventListener('click', function() {
                // กรองข้อมูลเฉพาะช่างติดตั้ง
                const filteredData = data.filter(row => {
                    const workType = row['Type of work'];
                    return workType && workType.toString().includes('Installation');
                });
                
                // อัปเดตการ์ดและตาราง
                createDashboardSummary(filteredData);
                createRSMChart(allData, filteredData);
                createProviderChart(allData, filteredData);
                createCTMChart(allData, filteredData);
                showFilterMessage('แสดงข้อมูลเฉพาะช่างติดตั้ง');
                
                // เพิ่ม visual feedback
                highlightActiveCard(card);
            });
            
            // เพิ่ม hover effect
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            });
            
            return card;
        }
        
        // นับจำนวนช่างซ่อม
function countRepairTechsInData(data) {
    // นับจำนวนข้อมูลที่มีคำว่า "Repair" ในคอลัมน์ Type of work และมีคำว่า "หัวหน้า" หรือ "ลูกน้อง" ในคอลัมน์สถานะกองงาน
    const repairCount = data.filter(row => {
        const workValue = row['Type of work'];
        const statusValue = row['สถานะกองงาน'];
        return workValue && 
               workValue.toString().includes('Repair') && 
               statusValue && 
               (statusValue.toString().includes('หัวหน้า') || statusValue.toString().includes('ลูกน้อง'));
    }).length;
    
    return repairCount;
}
        
        // สร้างการ์ดสำหรับแสดงจำนวนช่างซ่อม
        function createRepairTechsCardElement(data) {
            const repairCount = countRepairTechsInData(data);
            
                // นับจำนวนกองงานช่างซ่อม (นับเฉพาะที่มีคำว่า "หัวหน้า" ในคอลัมน์ "สถานะกองงาน")
    const repairGroupCount = data.filter(row => {
        const typeValue = row['Type of work'];
        const statusValue = row['สถานะกองงาน'];
        return typeValue && 
              typeValue.toString().includes('Repair') && 
              statusValue && 
              statusValue.toString().includes('หัวหน้า');
    }).length;
            
            // สร้างการ์ด
            const card = document.createElement('div');
            card.className = 'card';
            card.style.flex = '1';
            card.style.cursor = 'pointer';
            card.style.transition = 'all 0.3s ease';
            card.innerHTML = `
            <i class="fas fa-wrench card-icon"></i>
            <h3>ช่างซ่อม</h3>
            <div class="card-detail-line">
                <span class="card-detail-value">${repairGroupCount.toLocaleString()}</span>
                <span class="card-detail-label">กองงาน</span>
            </div>
            <div class="card-detail-line">
                <span class="card-detail-value">${repairCount.toLocaleString()}</span>
                <span class="card-detail-label">คน</span>
            </div>
            `;
            
            // เพิ่ม click event
            card.addEventListener('click', function() {
                // กรองข้อมูลเฉพาะช่างซ่อม
                const filteredData = data.filter(row => {
                    const workType = row['Type of work'];
                    return workType && workType.toString().includes('Repair');
                });
                
                // อัปเดตการ์ดและตาราง
                createDashboardSummary(filteredData);
                createRSMChart(allData, filteredData);
                createProviderChart(allData, filteredData);
                createCTMChart(allData, filteredData);
                showFilterMessage('แสดงข้อมูลเฉพาะช่างซ่อม');
                
                // เพิ่ม visual feedback
                highlightActiveCard(card);
            });
            
            // เพิ่ม hover effect
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
            });
            
            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '';
            });
            
            return card;
        }
        
        // Create dashboard summary cards for specific columns
        function createDashboardSummary(data) {
            if (data.length === 0) return;
            
            // Clear dashboard
            dashboardElement.innerHTML = '';
            
            // สร้าง container สำหรับการ์ด 2 แถว
            const cardContainer = document.createElement('div');
            cardContainer.style.display = 'flex';
            cardContainer.style.flexDirection = 'column';
            cardContainer.style.gap = '10px';
            cardContainer.style.width = '100%';
            
            // แถวที่ 1: การ์ด 2 อัน
            const row1 = document.createElement('div');
            row1.style.display = 'flex';
            row1.style.gap = '10px';
            row1.style.width = '100%';
            
            // แถวที่ 2: การ์ด 2 อัน
            const row2 = document.createElement('div');
            row2.style.display = 'flex';
            row2.style.gap = '10px';
            row2.style.width = '100%';
            
            // สร้างการ์ดแถวที่ 1
            const leadersCard = createLeadersCardElement(data);
            const techsCard = createTechsCardElement(data);
            
            // สร้างการ์ดแถวที่ 2
            const installCard = createInstallTechsCardElement(data);
            const repairCard = createRepairTechsCardElement(data);
            
            // เพิ่มการ์ดเข้าแถว
            row1.appendChild(leadersCard);
            row1.appendChild(techsCard);
            row2.appendChild(installCard);
            row2.appendChild(repairCard);
            
            // เพิ่มแถวเข้า container
            cardContainer.appendChild(row1);
            cardContainer.appendChild(row2);
            
            // เพิ่ม container เข้า dashboard
            dashboardElement.appendChild(cardContainer);
            
            // สร้างตาราง Pivot Table
            createPivotTable(data);
        }
        
        // สร้างตาราง Pivot Table สำหรับกองงานช่าง
        function createPivotTable(data) {
            if (data.length === 0) return;
            
            // กรองข้อมูลเฉพาะที่มีคำว่า "หัวหน้า" ในคอลัมน์ "สถานะกองงาน"
            const leaderData = data.filter(row => {
                const statusValue = row['สถานะกองงาน'];
                return statusValue && statusValue.toString().includes('หัวหน้า');
            });
            
            // สร้าง object สำหรับเก็บข้อมูลแยกตาม Provider
            const pivotData = {};
            
            // ประมวลผลข้อมูล
            leaderData.forEach(row => {
                const provider = row['Provider'] || 'ไม่ระบุ';
                const workType = row['Type of work'] || '';
                
                // สร้าง provider ใน pivotData ถ้ายังไม่มี
                if (!pivotData[provider]) {
                    pivotData[provider] = {
                        installation: 0,
                        repair: 0
                    };
                }
                
                // นับจำนวนตามประเภทงาน
                if (workType.includes('Installation')) {
                    pivotData[provider].installation++;
                } else if (workType.includes('Repair')) {
                    pivotData[provider].repair++;
                }
            });
            
            // สร้าง HTML สำหรับตาราง
            let tableHTML = '';
            let totalInstallation = 0;
            let totalRepair = 0;
            
            // เรียงลำดับ Provider ตามที่ต้องการ
            const providerOrder = ['True Tech', 'WW-Provider', 'เถ้าแก่เทค'];
            
            providerOrder.forEach(provider => {
                if (pivotData[provider]) {
                    const installation = pivotData[provider].installation;
                    const repair = pivotData[provider].repair;
                    const total = installation + repair;
                    
                    totalInstallation += installation;
                    totalRepair += repair;
                    
                    tableHTML += `
                        <tr>
                            <td>${provider}</td>
                            <td>${installation.toLocaleString()}</td>
                            <td>${repair.toLocaleString()}</td>
                            <td>${total.toLocaleString()}</td>
                        </tr>
                    `;
                }
            });
            
            // อัปเดตตาราง
            pivotTableBodyElement.innerHTML = tableHTML;
            
            // อัปเดตยอดรวม
            document.getElementById('total-installation').textContent = totalInstallation.toLocaleString();
            document.getElementById('total-repair').textContent = totalRepair.toLocaleString();
            document.getElementById('grand-total').textContent = (totalInstallation + totalRepair).toLocaleString();
            
            // แสดงตาราง
            pivotTableContainerElement.style.display = 'block';
        }
        
        // ฟังก์ชันไฮไลท์การ์ดที่เลือก
        function highlightActiveCard(activeCard) {
            // ลบไฮไลท์จากทุกการ์ด
            document.querySelectorAll('.card').forEach(card => {
                card.style.border = '';
                card.style.backgroundColor = '';
            });
            
            // ไฮไลท์การ์ดที่เลือก
            activeCard.style.border = '3px solid #3498db';
            activeCard.style.backgroundColor = '#f8f9fa';
        }
        
        // เพิ่มการจัดการ click ที่พื้นที่ว่างของกราฟ
        function setupChartClickHandler() {
            const chartContainer = document.getElementById('chart-container');
            chartContainer.addEventListener('click', function(event) {
                // ตรวจสอบว่าคลิกที่พื้นที่ว่างหรือไม่ (ไม่ใช่ที่แท่งกราฟ)
                if (event.target.tagName === 'CANVAS') {
                    const rect = event.target.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    
                    // ตรวจสอบว่าคลิกที่พื้นที่ว่างหรือไม่
                    const chart = rsmChart;
                    if (chart && currentFilter) {
                        const elements = chart.getElementsAtEventForMode(
                            { x: x, y: y },
                            'nearest',
                            { intersect: true },
                            false
                        );
                        
                        // ถ้าไม่มี elements แสดงว่าคลิกที่พื้นที่ว่าง
                        if (elements.length === 0) {
                            resetToAllData();
                        }
                    }
                }
            });
        }
        
        // ฟังก์ชันรีเซ็ตกลับไปแสดงข้อมูลทั้งหมด
        function resetToAllData() {
            currentFilter = null;
            createRSMChart(allData);
            createProviderChart(allData);
            createCTMChart(allData);
            showFilterMessage('แสดงข้อมูลทั้งหมด');
            
            // ลบไฮไลท์จากทุกการ์ด
            document.querySelectorAll('.card').forEach(card => {
                card.style.border = '';
                card.style.backgroundColor = '';
            });
        }
        
        // เพิ่มการจัดการ click ที่พื้นที่ว่างของหน้าเว็บ
        function setupGlobalClickHandler() {
            document.addEventListener('click', function(event) {
                // ตรวจสอบว่าคลิกที่พื้นที่ว่างหรือไม่ (ไม่ใช่ที่การ์ด กราฟ หรือตาราง)
                const isCard = event.target.closest('.card');
                const isChart = event.target.closest('#chart-container');
                const isTable = event.target.closest('#pivot-table-container');
                const isDashboard = event.target.closest('#dashboard');
                
                if (!isCard && !isChart && !isTable && !isDashboard) {
                    resetToAllData();
                }
            });
        }
        
        // ฟังก์ชัน debounce สำหรับการค้นหา
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        // Search function with debounce
        const debouncedSearch = debounce(function() {
            searchData();
        }, 300); // รอ 300ms หลังจากหยุดพิมพ์
        
        // Search function
        function searchData() {
            searchTerm = searchInputElement.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                displayData = [...allData];
            } else {
                displayData = allData.filter(row => {
                    // Search in all columns
                    return Object.values(row).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            // อัปเดตการ์ดข้อมูลสรุปใหม่หลังการค้นหา
            createProviderCards(displayData);
            createProviderChart(displayData);
            createCTMChart(displayData);
            
            // Apply current sorting if any
            if (currentSortColumn) {
                sortTable(currentSortColumn);
                return; // sortTable will reset page and render
            }
            
            currentPage = 1; // Reset to first page
            renderTable();
        }
        
        // Pagination functions
        function getPaginatedData() {
            const startIndex = (currentPage - 1) * rowsPerPage;
            return displayData.slice(startIndex, startIndex + rowsPerPage);
        }
        
        function getTotalPages() {
            return Math.ceil(displayData.length / rowsPerPage);
        }
        
        function renderPagination() {
            const totalPages = getTotalPages();
            
            // Clear pagination
            paginationElement.innerHTML = '';
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '&laquo;';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                }
            });
            paginationElement.appendChild(prevButton);
            
            // Page buttons
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // First page button if not visible
            if (startPage > 1) {
                const firstButton = document.createElement('button');
                firstButton.textContent = '1';
                firstButton.addEventListener('click', () => {
                    currentPage = 1;
                    renderTable();
                });
                paginationElement.appendChild(firstButton);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 8px';
                    paginationElement.appendChild(ellipsis);
                }
            }
            
            // Page buttons
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = currentPage === i ? 'active' : '';
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    renderTable();
                });
                paginationElement.appendChild(pageButton);
            }
            
            // Last page button if not visible
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.style.padding = '0 8px';
                    paginationElement.appendChild(ellipsis);
                }
                
                const lastButton = document.createElement('button');
                lastButton.textContent = totalPages;
                lastButton.addEventListener('click', () => {
                    currentPage = totalPages;
                    renderTable();
                });
                paginationElement.appendChild(lastButton);
            }
            
            // Next button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '&raquo;';
            nextButton.disabled = currentPage === totalPages || totalPages === 0;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                }
            });
            paginationElement.appendChild(nextButton);
        }
        
        // Create and render data table with pagination (ปรับปรุงประสิทธิภาพ)
        function renderTable() {
            const paginatedData = getPaginatedData();
            
            if (paginatedData.length === 0) {
                dataTableElement.innerHTML = '<tr><td colspan="100%" style="text-align: center;">ไม่พบข้อมูล</td></tr>';
                paginationElement.innerHTML = '';
                return;
            }
            
            // Get the column names
            const columns = Object.keys(paginatedData[0]);
            
            // Function to format column header - ไม่ตัดบรรทัด
            function formatColumnHeader(column) {
                // แปลงชื่อคอลัมน์ให้สั้นลงและอยู่ในบรรทัดเดียว
                const columnMappings = {
                    'Type of Provider Group': 'Provider Group',
                    'Type of work': 'Work Type',
                    'ประเภทการรับงาน': 'Job Type',
                    'Depot_Name': 'Depot Name',
                    'Depot_Code': 'Depot Code',
                    'Tech_Name': 'Tech Name',
                    'Tech_Surename': 'Tech Surname',
                    'Tech_ID': 'Tech ID',
                    'Register_Date': 'Register Date',
                    'Expire_Date': 'Expire Date',
                    'บัตรหมดอายุ(วัน)': 'Expire Days',
                    'จำนวนกองงาน': 'Teams',
                    'จำนวนช่าง': 'Techs',
                    'สถานะกองงาน': 'Team Status'
                };
                
                return columnMappings[column] || column;
            }
            
            // Define column sizes based on the column name
            const columnSizes = {
                'Area': 'col-sm',
                'Provider': 'col-md',
                'CTM': 'col-sm',
                'RSM': 'col-md',
                'Type of Provider Group': 'col-md',
                'Type of work': 'col-sm',
                'ประเภทการรับงาน': 'col-sm',
                'Group': 'col-sm',
                'Province': 'col-sm',
                'Depot_Name': 'col-md',
                'Depot_Code': 'col-sm',
                'O-Type': 'col-sm',
                'จำนวนกองงาน': 'col-sm',
                'จำนวนช่าง': 'col-sm',
                'Tech_Name': 'col-md',
                'Tech_Surename': 'col-md',
                'Tech_ID': 'col-sm',
                'Register_Date': 'col-sm',
                'Expire_Date': 'col-sm',
                'บัตรหมดอายุ(วัน)': 'col-sm',
                'Status': 'col-sm'
            };
            
            // สร้าง table header และ body แยกกันเพื่อลดการ reflow
            let tableHeader = '<thead><tr>';
            let tableBody = '<tbody>';
            
            // Create table header
            columns.forEach(column => {
                const colSize = columnSizes[column] || 'col-md';
                const sortingClass = column === currentSortColumn 
                    ? `sorting-${currentSortDirection}` 
                    : 'sorting';
                tableHeader += `<th class="${colSize} ${sortingClass}" data-column="${column}" style="white-space: nowrap; text-align: center; font-size: 12px; padding: 8px 4px;">${formatColumnHeader(column)}</th>`;
            });
            tableHeader += '</tr></thead>';
            
            // Create table rows - ใช้ DocumentFragment เพื่อประสิทธิภาพที่ดีขึ้น
            const fragment = document.createDocumentFragment();
            const tempTable = document.createElement('table');
            
            // Create table rows
            paginatedData.forEach(row => {
                let rowHtml = '<tr>';
                columns.forEach(column => {
                    const cellValue = row[column] || '';
                    // Add data attribute to store full text for tooltip
                    rowHtml += `<td class="truncate" data-full-text="${cellValue}">${cellValue}</td>`;
                });
                rowHtml += '</tr>';
                tableBody += rowHtml;
            });
            
            tableBody += '</tbody>';
            
            // อัพเดท DOM เพียงครั้งเดียว
            dataTableElement.innerHTML = tableHeader + tableBody;
            
            // Add sorting event listeners
            document.querySelectorAll('#data-table th').forEach(headerCell => {
                headerCell.addEventListener('click', () => {
                    const column = headerCell.getAttribute('data-column');
                    sortTable(column);
                });
            });
            
            // Render pagination
            renderPagination();
        }
        
        // Download Excel function
        function downloadExcel() {
            if (displayData.length === 0) {
                alert('ไม่มีข้อมูลที่จะดาวน์โหลด');
                return;
            }
            
            // Convert data to worksheet
            const worksheet = XLSX.utils.json_to_sheet(displayData);
            
            // Create workbook and add the worksheet
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Data");
            
            // Generate Excel file and trigger download
            const today = new Date();
            const dateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            XLSX.writeFile(workbook, `data_export_${dateStr}.xlsx`);
        }
        
        // Show error message
        function showError(message) {
            loadingElement.style.display = 'none';
            errorMessageElement.textContent = message;
            errorMessageElement.style.display = 'block';
        }
        
        // Event listeners
        searchButtonElement.addEventListener('click', debouncedSearch);
        
        searchInputElement.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                debouncedSearch();
            } else {
                // ค้นหาอัตโนมัติขณะพิมพ์
                debouncedSearch();
            }
        });
        
        rowsSelectElement.addEventListener('change', function() {
            rowsPerPage = parseInt(this.value);
            currentPage = 1; // Reset to first page
            renderTable();
        });
        
        downloadExcelElement.addEventListener('click', downloadExcel);
        
        // Add refresh button event listener
        document.getElementById('refresh-button').addEventListener('click', function() {
            // แสดง loading ระหว่างรีเฟรช
            loadingElement.style.display = 'block';
            tableContainerElement.style.display = 'none';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('chart-container').style.display = 'none';
            document.getElementById('provider-cards-container').style.display = 'none';
            document.getElementById('provider-chart-container').style.display = 'none';
            document.getElementById('ctm-chart-container').style.display = 'none';
            pivotTableContainerElement.style.display = 'none';
            
            // รีเซ็ตแคชและดึงข้อมูลใหม่
            csvCache = null;
            lastFetchTime = 0;
            
            // ดึงข้อมูลใหม่
            setTimeout(() => {
                fetchDataAndVisualize();
            }, 100); // เพิ่มการหน่วงเวลาเล็กน้อยเพื่อให้ UI อัพเดทก่อน
        });
        
        // Sort function
        function sortTable(column) {
            // Toggle sort direction if clicking the same column
            if (column === currentSortColumn) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }
            
            // Sort the data
            displayData.sort((a, b) => {
                const valueA = a[column] || '';
                const valueB = b[column] || '';
                
                // Check if values are numbers
                const numA = parseFloat(valueA);
                const numB = parseFloat(valueB);
                
                if (!isNaN(numA) && !isNaN(numB)) {
                    // Numeric sorting
                    return currentSortDirection === 'asc' ? numA - numB : numB - numA;
                } else {
                    // String sorting
                    const stringA = valueA.toString().toLowerCase();
                    const stringB = valueB.toString().toLowerCase();
                    
                    if (stringA < stringB) {
                        return currentSortDirection === 'asc' ? -1 : 1;
                    }
                    if (stringA > stringB) {
                        return currentSortDirection === 'asc' ? 1 : -1;
                    }
                    return 0;
                }
            });
            
            // Reset to first page and re-render
            currentPage = 1;
            renderTable();
        }
        
        // เพิ่มฟังก์ชันสำหรับ filter ข้อมูลแบบมีส่วนร่วม
        function createFilterOptions() {
            // ตรวจสอบและลบ filter container เดิมถ้ามี
            const existingFilters = document.querySelectorAll('.filter-container');
            existingFilters.forEach(filter => filter.remove());
            
            // สร้างตัวกรองตามคอลัมน์ที่เลือก
            const filterContainer = document.createElement('div');
            filterContainer.className = 'filter-container';
            filterContainer.style.display = 'flex';
            filterContainer.style.flexWrap = 'wrap';
            filterContainer.style.gap = '10px';
            
            // สร้างตัวเลือกคอลัมน์สำหรับ filter (ลบ Group ออก)
            const columns = Object.keys(allData[0] || {});
            // กำหนดลำดับของตัวกรองใหม่ โดยเพิ่ม "Type of work" และ "RSM" ไว้หน้า "Province" และลบ Group ออก
            const importantColumns = ['Provider', 'Type of Provider Group', 'Type of work', 'RSM', 'Province'];
            
            importantColumns.forEach(column => {
                if (!columns.includes(column)) return;
                
                // สร้างค่าที่เป็นไปได้ทั้งหมดของคอลัมน์
                let uniqueValues = [...new Set(allData.map(item => item[column]).filter(Boolean))];
                
                // กรองคำว่า "MPLS", "Other", "Audit(QC)", "Solar" ออกจาก "Type of work"
                if (column === 'Type of work') {
                    uniqueValues = uniqueValues.filter(value => value !== 'MPLS' && value !== 'Other' && value !== 'Audit(QC)' && value !== 'Solar');
                }
                
                // สำหรับ Type of work ให้แสดงเฉพาะ "Installation" และ "Repair"
                if (column === 'Type of work') {
                    uniqueValues = uniqueValues.filter(value => value === 'Installation' || value === 'Repair');
                }
                
                if (uniqueValues.length <= 1) return; // ข้ามถ้ามีค่าเดียวหรือไม่มีค่า
                
                // สร้าง multiselect dropdown
                const filterGroup = document.createElement('div');
                filterGroup.style.display = 'flex';
                filterGroup.style.flexDirection = 'column';
                
                const label = document.createElement('div');
                label.textContent = formatColumnHeaderText(column) + ':';
                label.className = 'filter-label';
                
                // สร้าง multiselect dropdown
                const multiselect = document.createElement('div');
                multiselect.className = 'multiselect-dropdown';
                multiselect.setAttribute('data-column', column);
                
                // สร้าง header ของ multiselect
                const header = document.createElement('div');
                header.className = 'multiselect-dropdown-header';
                
                const headerText = document.createElement('div');
                headerText.className = 'multiselect-dropdown-header-text';
                headerText.textContent = 'ทั้งหมด';
                
                header.appendChild(headerText);
                
                // สร้าง content ของ multiselect
                const content = document.createElement('div');
                content.className = 'multiselect-dropdown-content';
                
                // เพิ่มตัวเลือก "เลือกทั้งหมด"
                const selectAllDiv = document.createElement('div');
                selectAllDiv.className = 'multiselect-select-all';
                
                const selectAllCheckbox = document.createElement('input');
                selectAllCheckbox.type = 'checkbox';
                selectAllCheckbox.checked = true;
                selectAllCheckbox.addEventListener('change', function() {
                    const options = content.querySelectorAll('.multiselect-option input');
                    options.forEach(option => {
                        option.checked = this.checked;
                    });
                    updateMultiselectHeader(multiselect, uniqueValues);
                    applyFilters();
                });
                
                const selectAllLabel = document.createTextNode('เลือกทั้งหมด');
                
                selectAllDiv.appendChild(selectAllCheckbox);
                selectAllDiv.appendChild(selectAllLabel);
                content.appendChild(selectAllDiv);
                
                // เพิ่มตัวเลือกทั้งหมด
                uniqueValues.sort().forEach(value => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'multiselect-option';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = value;
                    checkbox.checked = true;
                    checkbox.addEventListener('change', function() {
                        // ตรวจสอบว่าทุกช่องถูกติ๊กหรือไม่
                        const allOptions = content.querySelectorAll('.multiselect-option input');
                        const allChecked = Array.from(allOptions).every(opt => opt.checked);
                        
                        // อัปเดตสถานะของเลือกทั้งหมด
                        const selectAllCheckbox = content.querySelector('.multiselect-select-all input');
                        selectAllCheckbox.checked = allChecked;
                        
                        updateMultiselectHeader(multiselect, uniqueValues);
                        applyFilters();
                    });
                    
                    const optionLabel = document.createTextNode(value);
                    
                    optionDiv.appendChild(checkbox);
                    optionDiv.appendChild(optionLabel);
                    content.appendChild(optionDiv);
                });
                
                // เพิ่ม event listener สำหรับการเปิด/ปิด dropdown
                header.addEventListener('click', function(e) {
                    e.stopPropagation();
                    this.classList.toggle('active');
                    content.classList.toggle('show');
                    
                    // ปิด dropdown อื่นๆ ที่อาจเปิดอยู่
                    document.querySelectorAll('.multiselect-dropdown-content.show').forEach(dropdown => {
                        if (dropdown !== content) {
                            dropdown.classList.remove('show');
                            dropdown.previousElementSibling.classList.remove('active');
                        }
                    });
                });
                
                // ปิด dropdown เมื่อคลิกที่อื่น
                document.addEventListener('click', function() {
                    content.classList.remove('show');
                    header.classList.remove('active');
                });
                
                // ป้องกันการปิด dropdown เมื่อคลิกภายใน dropdown
                content.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
                
                multiselect.appendChild(header);
                multiselect.appendChild(content);
                
                filterGroup.appendChild(label);
                filterGroup.appendChild(multiselect);
                filterContainer.appendChild(filterGroup);
            });
            
            // เพิ่มเข้าไปในหน้าเว็บ
            if (filterContainer.children.length > 0) {
                const tableControls = document.querySelector('.table-controls');
                tableControls.parentNode.insertBefore(filterContainer, tableControls.nextSibling);
            }
        }
        
        // ฟังก์ชันอัปเดตข้อความของ multiselect header
        function updateMultiselectHeader(multiselect, allValues) {
            const header = multiselect.querySelector('.multiselect-dropdown-header-text');
            const checkboxes = multiselect.querySelectorAll('.multiselect-option input');
            const checkedBoxes = Array.from(checkboxes).filter(cb => cb.checked);
            
            if (checkedBoxes.length === 0) {
                header.textContent = 'ไม่มีที่เลือก';
            } else if (checkedBoxes.length === checkboxes.length) {
                header.textContent = 'ทั้งหมด';
            } else if (checkedBoxes.length <= 2) {
                header.textContent = checkedBoxes.map(cb => cb.value).join(', ');
            } else {
                header.textContent = `เลือก ${checkedBoxes.length} รายการ`;
            }
        }
        
        // แปลงชื่อคอลัมน์เป็นข้อความสำหรับ label
        function formatColumnHeaderText(column) {
            // คืนค่าชื่อคอลัมน์เดิมโดยไม่มีการแปลง
            return column;
        }
        
        // ประมวลผล filter ทั้งหมด
        function applyFilters() {
            const filters = {};
            
            // รวบรวมค่า filter ทั้งหมด
            document.querySelectorAll('.multiselect-dropdown').forEach(multiselect => {
                const column = multiselect.getAttribute('data-column');
                const selectedValues = Array.from(
                    multiselect.querySelectorAll('.multiselect-option input:checked')
                ).map(cb => cb.value);
                
                if (selectedValues.length > 0 && selectedValues.length < multiselect.querySelectorAll('.multiselect-option input').length) {
                    filters[column] = selectedValues;
                }
            });
            
            // กรองข้อมูล
            if (Object.keys(filters).length === 0) {
                displayData = searchTerm ? 
                    allData.filter(row => Object.values(row).some(val => 
                        val && val.toString().toLowerCase().includes(searchTerm.toLowerCase())
                    )) : 
                    [...allData];
            } else {
                displayData = allData.filter(row => {
                    return Object.keys(filters).every(column => {
                        return filters[column].includes(row[column]);
                    });
                });
                
                if (searchTerm) {
                    displayData = displayData.filter(row => 
                        Object.values(row).some(val => 
                            val && val.toString().toLowerCase().includes(searchTerm.toLowerCase())
                        )
                    );
                }
            }
            
            // อัปเดตการ์ดข้อมูลสรุป กราฟ และตาราง Pivot
            createRSMChart(displayData);
            createProviderCards(displayData);
            createProviderChart(displayData);
            createCTMChart(displayData);
            createPivotTable(displayData);
            
            currentPage = 1;
            renderTable();
        }
        
        // ตัวแปรสำหรับเก็บสถานะการกรอง
        let currentFilter = null;
        
        // ฟังก์ชันแสดงข้อความแจ้งเตือน
        function showFilterMessage(message) {
            // สร้างหรืออัปเดตข้อความแจ้งเตือน
            let filterMessage = document.getElementById('filter-message');
            if (!filterMessage) {
                filterMessage = document.createElement('div');
                filterMessage.id = 'filter-message';
                filterMessage.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #3498db;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    z-index: 1000;
                    font-weight: bold;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                `;
                document.body.appendChild(filterMessage);
            }
            filterMessage.textContent = message;
            
            // ซ่อนข้อความหลังจาก 3 วินาที
            setTimeout(() => {
                filterMessage.style.display = 'none';
            }, 3000);
        }
        
        // เพิ่มฟังก์ชันสำหรับสร้างและอัปเดตกราฟ RSM
        function createRSMChart(data, filteredData = null) {
            // ใช้ข้อมูลที่กรองแล้วถ้ามี หรือใช้ข้อมูลทั้งหมด
            const chartData = filteredData || data;
            const rsmList = [
                'RSM1_BMA-West',
                'RSM2_BMA-East',
                'RSM3_UPC-East',
                'RSM4_UPC-NOR',
                'RSM5_UPC-NOE1',
                'RSM6_UPC-NOE2',
                'RSM7_UPC-CEW',
                'RSM8_UPC-SOU'
            ];

            // นับจำนวนหัวหน้าตาม RSM และ Type of work
            const installationCounts = rsmList.map(rsm => {
                return chartData.filter(row => 
                    row['RSM'] === rsm && 
                    row['สถานะกองงาน'] && 
                    row['สถานะกองงาน'].includes('หัวหน้า') &&
                    row['Type of work'] && 
                    row['Type of work'].includes('Installation')
                ).length;
            });

            const repairCounts = rsmList.map(rsm => {
                return chartData.filter(row => 
                    row['RSM'] === rsm && 
                    row['สถานะกองงาน'] && 
                    row['สถานะกองงาน'].includes('หัวหน้า') &&
                    row['Type of work'] && 
                    row['Type of work'].includes('Repair')
                ).length;
            });

            // ถ้ามีกราฟอยู่แล้ว ให้ทำลายก่อนสร้างใหม่
            if (rsmChart) {
                rsmChart.destroy();
            }

            // สร้างกราฟใหม่
            const ctx = document.getElementById('rsmChart').getContext('2d');
            rsmChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: rsmList.map(rsm => rsm.split('_')[0]), // แสดงเฉพาะส่วนหน้า _
                    datasets: [
                        {
                            label: 'ช่างติดตั้ง',
                            data: installationCounts,
                            backgroundColor: 'rgba(52, 152, 219, 0.8)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'ช่างซ่อม',
                            data: repairCounts,
                            backgroundColor: 'rgba(231, 76, 60, 0.8)',
                            borderColor: 'rgba(231, 76, 60, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        // จัดการ click event
                        if (elements.length > 0) {
                            const element = elements[0];
                            const rsmIndex = element.index;
                            const rsmName = rsmList[rsmIndex];
                            
                            // กรองข้อมูลตาม RSM ที่คลิก
                            const filteredData = data.filter(row => row['RSM'] === rsmName);
                            currentFilter = rsmName;
                            
                            // อัปเดตการ์ดและตารางด้วยข้อมูลที่กรองแล้ว
                            createRSMChart(data, filteredData);
                            
                            // แสดงข้อความแจ้งเตือน
                            showFilterMessage(`แสดงข้อมูลเฉพาะ ${rsmName.split('_')[0]}`);
                        } else {
                            // คลิกที่พื้นที่ว่าง - กลับไปแสดงข้อมูลทั้งหมด
                            if (currentFilter) {
                                currentFilter = null;
                                createRSMChart(data);
                                showFilterMessage('แสดงข้อมูลทั้งหมด');
                            }
                        }
                    },
                    onHover: function(event, elements) {
                        // เปลี่ยน cursor เมื่อ hover
                        const canvas = event.native.target;
                        canvas.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    },
                    animation: {
                        onComplete: function(animation) {
                            // ยอดรวมเหนือกราฟ: ใช้ Canvas API ใน animation.onComplete
                            // รอให้กราฟโหลดเสร็จก่อน
                            const chart = animation.chart;
                            const ctx = chart.ctx;
                            
                            // แสดงจำนวนรวมเหนือกราฟ และตัวเลขในแท่ง
                            chart.data.labels.forEach(function(label, index) {
                                // คำนวณยอดรวม: Installation + Repair
                                const total = chart.data.datasets.reduce((sum, dataset) => sum + dataset.data[index], 0);
                                
                                if (total > 0) {
                                    // หา y position ของแท่งบนสุด (dataset ล่าสุดที่มีข้อมูล)
                                    let topY = chart.chartArea.bottom;
                                    for (let i = chart.data.datasets.length - 1; i >= 0; i--) {
                                        if (chart.data.datasets[i].data[index] > 0) {
                                            const meta = chart.getDatasetMeta(i);
                                            const bar = meta.data[index];
                                            topY = bar.y;
                                            break;
                                        }
                                    }
                                    
                                    // ใช้ x position จาก dataset แรก
                                    const meta0 = chart.getDatasetMeta(0);
                                    const bar0 = meta0.data[index];
                                    
                                    // วาดยอดรวมเหนือแท่ง
                                    ctx.fillStyle = '#000000';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    ctx.font = 'bold 14px Arial';
                                    ctx.fillText(total, bar0.x, topY - 10);
                                }
                                
                                // แสดงตัวเลขในแต่ละแท่ง
                                chart.data.datasets.forEach(function(dataset, datasetIndex) {
                                    const value = dataset.data[index];
                                    if (value > 0) {
                                        const meta = chart.getDatasetMeta(datasetIndex);
                                        const bar = meta.data[index];
                                        
                                        // ใช้สีขาวสำหรับตัวเลขในแท่ง
                                        ctx.fillStyle = '#FFFFFF';
                                        ctx.strokeStyle = '#000000';
                                        ctx.lineWidth = 1;
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';
                                        ctx.font = 'bold 12px Arial';
                                        
                                        // แสดงตัวเลขตรงกลางแท่ง
                                        ctx.strokeText(value, bar.x, bar.y);
                                        ctx.fillText(value, bar.x, bar.y);
                                    }
                                });
                            });
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'จำนวนกองงานแยกตาม RSM และประเภทงาน',
                            font: {
                                size: 16
                            },
                            padding: {
                                top: 10,
                                bottom: 15
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                afterBody: function(context) {
                                    const total = context.reduce((sum, item) => sum + item.parsed.y, 0);
                                    return `รวม: ${total} กองงาน`;
                                }
                            }
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                afterBody: function(context) {
                                    const total = context.reduce((sum, item) => sum + item.parsed.y, 0);
                                    return `รวม: ${total} กองงาน`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 30 // เพิ่ม padding สำหรับยอดรวม
                        }
                    }
                }
            });
        }
        
        // สร้างฟังก์ชันสำหรับอัปเดตการ์ด Provider
        function createProviderCards(data) {
            // กรองข้อมูลเฉพาะแถวที่มีคำว่า "หัวหน้า" ในคอลัมน์ "สถานะกองงาน"
            const leaderData = data.filter(row => {
                const statusValue = row['สถานะกองงาน'];
                return statusValue && statusValue.toString().includes('หัวหน้า');
            });
            
            // กรองข้อมูลที่มีคำว่า "หัวหน้า" หรือ "ลูกน้อง" สำหรับนับจำนวนคน
            const peopleData = data.filter(row => {
                const statusValue = row['สถานะกองงาน'];
                return statusValue && (statusValue.toString().includes('หัวหน้า') || statusValue.toString().includes('ลูกน้อง'));
            });
            
            // นับจำนวนกองงานแต่ละ Provider (เฉพาะหัวหน้า)
            let totalAll = 0;
            let totalWW = 0;
            let totalTrue = 0;
            let totalThaokae = 0;
            
            leaderData.forEach(row => {
                const provider = row['Provider'];
                if (provider === 'WW-Provider') {
                    totalWW++;
                } else if (provider === 'True Tech') {
                    totalTrue++;
                } else if (provider === 'เถ้าแก่เทค') {
                    totalThaokae++;
                }
                totalAll++;
            });
            
            // นับจำนวนคนแต่ละ Provider (หัวหน้า + ลูกน้อง)
            let peopleAll = 0;
            let peopleWW = 0;
            let peopleTrue = 0;
            let peopleThaokae = 0;
            
            peopleData.forEach(row => {
                const provider = row['Provider'];
                if (provider === 'WW-Provider') {
                    peopleWW++;
                } else if (provider === 'True Tech') {
                    peopleTrue++;
                } else if (provider === 'เถ้าแก่เทค') {
                    peopleThaokae++;
                }
                peopleAll++;
            });
            
            // นับจำนวน Depot ที่ไม่ซ้ำกันแต่ละ Provider (ใช้ข้อมูลทั้งหมด ไม่ใช่แค่หัวหน้า)
            const depotsWW = new Set();
            const depotsTrue = new Set();
            const depotsThaokae = new Set();
            const depotsAll = new Set();
            
            data.forEach(row => {
                const provider = row['Provider'];
                const depotCode = row['Depot_Code'];
                
                if (depotCode) {
                    depotsAll.add(depotCode);
                    
                    if (provider === 'WW-Provider') {
                        depotsWW.add(depotCode);
                    } else if (provider === 'True Tech') {
                        depotsTrue.add(depotCode);
                    } else if (provider === 'เถ้าแก่เทค') {
                        depotsThaokae.add(depotCode);
                    }
                }
            });
            
            // อัปเดตตัวเลขในการ์ดกองงาน (แสดงจำนวนคนในวงเล็บ)
            document.getElementById('total-all-providers').innerHTML = `${totalAll.toLocaleString()} <span style="font-size: 14px; opacity: 0.8;">(${peopleAll.toLocaleString()} คน)</span>`;
            document.getElementById('total-ww-provider').innerHTML = `${totalWW.toLocaleString()} <span style="font-size: 14px; opacity: 0.8;">(${peopleWW.toLocaleString()} คน)</span>`;
            document.getElementById('total-true-tech').innerHTML = `${totalTrue.toLocaleString()} <span style="font-size: 14px; opacity: 0.8;">(${peopleTrue.toLocaleString()} คน)</span>`;
            document.getElementById('total-thaokae-tech').innerHTML = `${totalThaokae.toLocaleString()} <span style="font-size: 14px; opacity: 0.8;">(${peopleThaokae.toLocaleString()} คน)</span>`;
            
            // อัปเดตตัวเลขในการ์ด Depot
            document.getElementById('total-all-depots').textContent = depotsAll.size.toLocaleString();
            document.getElementById('depot-ww-provider').textContent = depotsWW.size.toLocaleString();
            document.getElementById('depot-true-tech').textContent = depotsTrue.size.toLocaleString();
            document.getElementById('depot-thaokae-tech').textContent = depotsThaokae.size.toLocaleString();
        }
        
        // สร้างฟังก์ชันสำหรับสร้างและอัปเดตกราฟ Provider
        function createProviderChart(data, filteredData = null) {
            // ใช้ข้อมูลที่กรองแล้วถ้ามี หรือใช้ข้อมูลทั้งหมด
            const chartData = filteredData || data;
            
            // กรองข้อมูลเฉพาะแถวที่มีคำว่า "หัวหน้า" ในคอลัมน์ "สถานะกองงาน"
            const leaderData = chartData.filter(row => {
                const statusValue = row['สถานะกองงาน'];
                return statusValue && statusValue.toString().includes('หัวหน้า');
            });
            
            // กำหนด RSM list
            const rsmList = [
                'RSM1_BMA-West',
                'RSM2_BMA-East', 
                'RSM3_UPC-East',
                'RSM4_UPC-NOR',
                'RSM5_UPC-NOE1',
                'RSM6_UPC-NOE2',
                'RSM7_UPC-CEW',
                'RSM8_UPC-SOU'
            ];
            
            // กำหนด Provider list
            const providerList = ['WW-Provider', 'True Tech', 'เถ้าแก่เทค'];
            
            // สร้างข้อมูลสำหรับแต่ละ Provider
            const datasets = providerList.map((provider, providerIndex) => {
                const data = rsmList.map(rsm => {
                    return leaderData.filter(row => 
                        row['RSM'] === rsm && 
                        row['Provider'] === provider
                    ).length;
                });
                
                // สีสำหรับแต่ละ Provider
                const colors = [
                    { bg: 'rgba(52, 152, 219, 0.8)', border: 'rgba(52, 152, 219, 1)' }, // WW-Provider - น้ำเงิน
                    { bg: 'rgba(46, 204, 113, 0.8)', border: 'rgba(46, 204, 113, 1)' }, // True Tech - เขียว
                    { bg: 'rgba(155, 89, 182, 0.8)', border: 'rgba(155, 89, 182, 1)' }  // เถ้าแก่เทค - ม่วง
                ];
                
                return {
                    label: provider,
                    data: data,
                    backgroundColor: colors[providerIndex].bg,
                    borderColor: colors[providerIndex].border,
                    borderWidth: 1
                };
            });
            
            // ถ้ามีกราฟอยู่แล้ว ให้ทำลายก่อนสร้างใหม่
            if (providerChart) {
                providerChart.destroy();
            }
            
            // สร้างกราฟใหม่
            const ctx = document.getElementById('providerChart').getContext('2d');
            providerChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: rsmList.map(rsm => rsm.split('_')[0]), // แสดงเฉพาะส่วนหน้า _
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        // จัดการ click event
                        if (elements.length > 0) {
                            const element = elements[0];
                            const rsmIndex = element.index;
                            const datasetIndex = element.datasetIndex;
                            const rsmName = rsmList[rsmIndex];
                            const providerName = providerList[datasetIndex];
                            
                            // กรองข้อมูลตาม RSM และ Provider ที่คลิก
                            const filteredData = data.filter(row => 
                                row['RSM'] === rsmName && 
                                row['Provider'] === providerName &&
                                row['สถานะกองงาน'] && 
                                row['สถานะกองงาน'].includes('หัวหน้า')
                            );
                            
                            // อัปเดตการ์ดและตารางด้วยข้อมูลที่กรองแล้ว
                            createRSMChart(data, filteredData);
                            createProviderChart(data, filteredData);
                            
                            // แสดงข้อความแจ้งเตือน
                            showFilterMessage(`แสดงข้อมูลเฉพาะ ${rsmName.split('_')[0]} - ${providerName}`);
                        } else {
                            // คลิกที่พื้นที่ว่าง - กลับไปแสดงข้อมูลทั้งหมด
                            if (currentFilter) {
                                currentFilter = null;
                                createRSMChart(data);
                                createProviderChart(data);
                                showFilterMessage('แสดงข้อมูลทั้งหมด');
                            }
                        }
                    },
                    onHover: function(event, elements) {
                        // เปลี่ยน cursor เมื่อ hover
                        const canvas = event.native.target;
                        canvas.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    },
                    animation: {
                        onComplete: function(animation) {
                            // แสดงยอดรวมเหนือแท่งและตัวเลขในแท่ง
                            const chart = animation.chart;
                            const ctx = chart.ctx;
                            
                            // แสดงจำนวนรวมเหนือกราฟ และตัวเลขในแท่ง
                            chart.data.labels.forEach(function(label, index) {
                                // คำนวณยอดรวม: รวมทุก Provider
                                const total = chart.data.datasets.reduce((sum, dataset) => sum + dataset.data[index], 0);
                                
                                if (total > 0) {
                                    // หา y position ของแท่งบนสุด
                                    let topY = chart.chartArea.bottom;
                                    for (let i = chart.data.datasets.length - 1; i >= 0; i--) {
                                        if (chart.data.datasets[i].data[index] > 0) {
                                            const meta = chart.getDatasetMeta(i);
                                            const bar = meta.data[index];
                                            topY = bar.y;
                                            break;
                                        }
                                    }
                                    
                                    // ใช้ x position จาก dataset แรก
                                    const meta0 = chart.getDatasetMeta(0);
                                    const bar0 = meta0.data[index];
                                    
                                    // วาดยอดรวมเหนือแท่ง
                                    ctx.fillStyle = '#000000';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    ctx.font = 'bold 14px Arial';
                                    ctx.fillText(total, bar0.x, topY - 10);
                                }
                                
                                // แสดงตัวเลขในแต่ละแท่ง (คำนวณตำแหน่งกลางของแต่ละส่วนในแท่ง stacked)
                                let cumulativeHeight = 0;
                                chart.data.datasets.forEach(function(dataset, datasetIndex) {
                                    const value = dataset.data[index];
                                    if (value > 0) {
                                        const meta = chart.getDatasetMeta(datasetIndex);
                                        const bar = meta.data[index];
                                        
                                        // คำนวณตำแหน่ง Y ที่อยู่กลางของแต่ละส่วนแท่ง
                                        const barHeight = bar.height;
                                        const centerY = bar.y + (barHeight / 2);
                                        
                                        // ใช้สีขาวสำหรับตัวเลขในแท่ง
                                        ctx.fillStyle = '#FFFFFF';
                                        ctx.strokeStyle = '#000000';
                                        ctx.lineWidth = 1.5;
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';
                                        ctx.font = 'bold 12px Arial';
                                        
                                        // แสดงตัวเลขตรงกลางของแต่ละส่วนแท่ง
                                        ctx.strokeText(value, bar.x, centerY);
                                        ctx.fillText(value, bar.x, centerY);
                                    }
                                });
                            });
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'จำนวนกองงานแยกตาม RSM และ Provider (เฉพาะหัวหน้า)',
                            font: {
                                size: 16
                            },
                            padding: {
                                top: 10,
                                bottom: 15
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                afterBody: function(context) {
                                    const total = context.reduce((sum, item) => sum + item.parsed.y, 0);
                                    return `รวม: ${total} กองงาน`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 30 // เพิ่ม padding สำหรับยอดรวม
                        }
                    }
                }
            });
        }
        
        // สร้างฟังก์ชันสำหรับสร้างและอัปเดตกราฟ CTM
        function createCTMChart(data, filteredData = null) {
            // ใช้ข้อมูลที่กรองแล้วถ้ามี หรือใช้ข้อมูลทั้งหมด
            const chartData = filteredData || data;
            
            // กรองข้อมูลเฉพาะแถวที่มีคำว่า "หัวหน้า" ในคอลัมน์ "สถานะกองงาน"
            const leaderData = chartData.filter(row => {
                const statusValue = row['สถานะกองงาน'];
                return statusValue && statusValue.toString().includes('หัวหน้า');
            });
            
            // ดึงรายการ CTM ที่ไม่ซ้ำกันและนับจำนวนรวม
            const ctmCounts = {};
            leaderData.forEach(row => {
                if (row['CTM']) {
                    if (!ctmCounts[row['CTM']]) {
                        ctmCounts[row['CTM']] = 0;
                    }
                    ctmCounts[row['CTM']]++;
                }
            });
            
            // เรียงลำดับ CTM ตามจำนวนรวมจากมากไปน้อย
            const sortedCtmList = Object.keys(ctmCounts).sort((a, b) => {
                return ctmCounts[b] - ctmCounts[a];
            });
            
            // แสดง CTM ทั้งหมดที่มีในข้อมูล (เรียงตามจำนวนรวม)
            const displayCtmList = sortedCtmList;
            
            // กำหนด Provider list
            const providerList = ['WW-Provider', 'True Tech', 'เถ้าแก่เทค'];
            
            // สร้างข้อมูลสำหรับแต่ละ Provider
            const datasets = providerList.map((provider, providerIndex) => {
                const data = displayCtmList.map(ctm => {
                    return leaderData.filter(row => 
                        row['CTM'] === ctm && 
                        row['Provider'] === provider
                    ).length;
                });
                
                // สีสำหรับแต่ละ Provider
                const colors = [
                    { bg: 'rgba(52, 152, 219, 0.8)', border: 'rgba(52, 152, 219, 1)' }, // WW-Provider - น้ำเงิน
                    { bg: 'rgba(46, 204, 113, 0.8)', border: 'rgba(46, 204, 113, 1)' }, // True Tech - เขียว
                    { bg: 'rgba(155, 89, 182, 0.8)', border: 'rgba(155, 89, 182, 1)' }  // เถ้าแก่เทค - ม่วง
                ];
                
                return {
                    label: provider,
                    data: data,
                    backgroundColor: colors[providerIndex].bg,
                    borderColor: colors[providerIndex].border,
                    borderWidth: 1
                };
            });
            
            // ถ้ามีกราฟอยู่แล้ว ให้ทำลายก่อนสร้างใหม่
            if (ctmChart) {
                ctmChart.destroy();
            }
            
            // สร้างกราฟใหม่
            const ctx = document.getElementById('ctmChart').getContext('2d');
            ctmChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: displayCtmList,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {
                        // จัดการ click event
                        if (elements.length > 0) {
                            const element = elements[0];
                            const ctmIndex = element.index;
                            const datasetIndex = element.datasetIndex;
                            const ctmName = displayCtmList[ctmIndex];
                            const providerName = providerList[datasetIndex];
                            
                            // กรองข้อมูลตาม CTM และ Provider ที่คลิก
                            const filteredData = data.filter(row => 
                                row['CTM'] === ctmName && 
                                row['Provider'] === providerName &&
                                row['สถานะกองงาน'] && 
                                row['สถานะกองงาน'].includes('หัวหน้า')
                            );
                            
                            // อัปเดตการ์ดและตารางด้วยข้อมูลที่กรองแล้ว
                            createRSMChart(data, filteredData);
                            createProviderChart(data, filteredData);
                            createCTMChart(data, filteredData);
                            
                            // แสดงข้อความแจ้งเตือน
                            showFilterMessage(`แสดงข้อมูลเฉพาะ ${ctmName} - ${providerName}`);
                        } else {
                            // คลิกที่พื้นที่ว่าง - กลับไปแสดงข้อมูลทั้งหมด
                            if (currentFilter) {
                                currentFilter = null;
                                createRSMChart(data);
                                createProviderChart(data);
                                createCTMChart(data);
                                showFilterMessage('แสดงข้อมูลทั้งหมด');
                            }
                        }
                    },
                    onHover: function(event, elements) {
                        // เปลี่ยน cursor เมื่อ hover
                        const canvas = event.native.target;
                        canvas.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    },
                    animation: {
                        onComplete: function(animation) {
                            // แสดงยอดรวมเหนือแท่งและตัวเลขในแท่ง
                            const chart = animation.chart;
                            const ctx = chart.ctx;
                            
                            // แสดงจำนวนรวมเหนือกราฟ และตัวเลขในแท่ง
                            chart.data.labels.forEach(function(label, index) {
                                // คำนวณยอดรวม: รวมทุก Provider
                                const total = chart.data.datasets.reduce((sum, dataset) => sum + dataset.data[index], 0);
                                
                                if (total > 0) {
                                    // หา y position ของแท่งบนสุด
                                    let topY = chart.chartArea.bottom;
                                    for (let i = chart.data.datasets.length - 1; i >= 0; i--) {
                                        if (chart.data.datasets[i].data[index] > 0) {
                                            const meta = chart.getDatasetMeta(i);
                                            const bar = meta.data[index];
                                            topY = bar.y;
                                            break;
                                        }
                                    }
                                    
                                    // ใช้ x position จาก dataset แรก
                                    const meta0 = chart.getDatasetMeta(0);
                                    const bar0 = meta0.data[index];
                                    
                                    // วาดยอดรวมเหนือแท่ง
                                    ctx.fillStyle = '#000000';
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'bottom';
                                    ctx.font = 'bold 14px Arial';
                                    ctx.fillText(total, bar0.x, topY - 10);
                                }
                                
                                // แสดงตัวเลขในแต่ละแท่ง (คำนวณตำแหน่งกลางของแต่ละส่วนในแท่ง stacked)
                                chart.data.datasets.forEach(function(dataset, datasetIndex) {
                                    const value = dataset.data[index];
                                    if (value > 0) {
                                        const meta = chart.getDatasetMeta(datasetIndex);
                                        const bar = meta.data[index];
                                        
                                        // คำนวณตำแหน่ง Y ที่อยู่กลางของแต่ละส่วนแท่ง
                                        const barHeight = bar.height;
                                        const centerY = bar.y + (barHeight / 2);
                                        
                                        // ใช้สีขาวสำหรับตัวเลขในแท่ง
                                        ctx.fillStyle = '#FFFFFF';
                                        ctx.strokeStyle = '#000000';
                                        ctx.lineWidth = 1.5;
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';
                                        ctx.font = 'bold 12px Arial';
                                        
                                        // แสดงตัวเลขตรงกลางของแต่ละส่วนแท่ง
                                        ctx.strokeText(value, bar.x, centerY);
                                        ctx.fillText(value, bar.x, centerY);
                                    }
                                });
                            });
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'จำนวนกองงานแยกตาม CTM และ Provider (เฉพาะหัวหน้า)',
                            font: {
                                size: 16
                            },
                            padding: {
                                top: 10,
                                bottom: 15
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                afterBody: function(context) {
                                    const total = context.reduce((sum, item) => sum + item.parsed.y, 0);
                                    return `รวม: ${total} กองงาน`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                autoSkip: false,
                                maxRotation: 90,
                                minRotation: 45,
                                font: {
                                    size: 10
                                },
                                callback: function(value, index, ticks) {
                                    // ตัดข้อความยาวเกินไป
                                    const label = this.getLabelForValue(value);
                                    if (label.length > 20) {
                                        return label.substring(0, 20) + '...';
                                    }
                                    return label;
                                }
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 30, // เพิ่ม padding สำหรับยอดรวม
                            bottom: 80 // เพิ่ม padding สำหรับ label CTM ที่หมุน
                        }
                    }
                }
            });
        }
        
        // Visitor Counter Functions
        function initializeVisitorCounter() {
            // ดึงจำนวนผู้เยี่ยมชมจาก localStorage
            let visitorCount = localStorage.getItem('visitorCount') || 0;
            
            // เพิ่มจำนวนผู้เยี่ยมชม
            visitorCount = parseInt(visitorCount) + 1;
            
            // บันทึกลง localStorage
            localStorage.setItem('visitorCount', visitorCount);
            
            // แสดงจำนวนผู้เยี่ยมชม
            updateVisitorCounter(visitorCount);
            
            // เพิ่ม animation เมื่อโหลดหน้า
            animateCounter(visitorCount);
        }
        
        function updateVisitorCounter(count) {
            const counterElement = document.getElementById('counter-number');
            if (counterElement) {
                counterElement.textContent = count.toLocaleString();
            }
        }
        
        function animateCounter(count) {
            const counterElement = document.getElementById('counter-number');
            if (!counterElement) return;
            
            // เคลียร์การตั้งค่าก่อนหน้า
            counterElement.style.transition = 'none';
            counterElement.offsetHeight; // trigger reflow
            
            // ตั้งค่าใหม่พร้อม animation
            counterElement.style.transition = 'transform 0.5s ease';
            counterElement.style.transform = 'scale(1.2)';
            
            setTimeout(() => {
                counterElement.style.transform = 'scale(1)';
            }, 500);
        }
        
        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
        loadingElement.style.display = 'block';
        fetchDataAndVisualize();
        initializeVisitorCounter();
        setupGlobalClickHandler();
        });
    </script>
</body>
</html>
